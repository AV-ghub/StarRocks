##### [The Insatiable Postgres Replication Slot](https://www.morling.dev/blog/insatiable-postgres-replication-slot/)
–ï—Å–ª–∏ —Å–ª–æ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ —Ä–∞—Å—Ç–µ—Ç, –∞ –∑–∞–¥–∞–Ω–∏–µ Flink —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–æ —ç—Ç–æ —Ä–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∏—Å–∫–∞.   
–ü—Ä–∏—á–∏–Ω–æ–π –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Flink, —Ç–∞–∫ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ Postgres.

### üõ†Ô∏è –ü—Ä–∏—á–∏–Ω—ã —Ä–æ—Å—Ç–∞ –∏ —Ä–µ—à–µ–Ω–∏—è

| –ü—Ä–∏—á–∏–Ω–∞ | –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å | –†–µ—à–µ–Ω–∏–µ |
| :--- | :--- | :--- |
| **1. –ó–∞–¥–∞–Ω–∏–µ Flink –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `confirmed_flush_lsn`** | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç—Å—è –ª–∏ `confirmed_flush_lsn`. –í –≤–∞—à–µ–º –∑–∞–ø—Ä–æ—Å–µ –≤–∏–¥–Ω–æ, —á—Ç–æ –æ–Ω –Ω–µ–º–Ω–æ–≥–æ —Ä–∞—Å—Ç–µ—Ç (`progress_from_restart` = 36 MB), –Ω–æ —ç—Ç–æ–≥–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ–∫–ø–æ–∏–Ω—Ç—ã (—Å–º. –Ω–∏–∂–µ). |
| **2. –ß–µ–∫–ø–æ–∏–Ω—Ç—ã –≤–æ Flink –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏–ª–∏ —Å–±–æ—è—Ç** | –í –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Flink –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —Å–æ–∑–¥–∞—é—Ç—Å—è –ª–∏ —É—Å–ø–µ—à–Ω—ã–µ —á–µ–∫–ø–æ–∏–Ω—Ç—ã. –ë–µ–∑ –Ω–∏—Ö LSN –Ω–µ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è. | –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —á–µ–∫–ø–æ–∏–Ω—Ç—ã. |
| **3. –í–Ω–µ—à–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ Postgres** | –í RDS —ç—Ç–æ –º–æ–≥—É—Ç –±—ã—Ç—å heartbeat-—Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î `rdsadmin`, –∫–æ—Ç–æ—Ä—ã–µ –ø–∏—à—É—Ç—Å—è —Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç. –û–Ω–∏ —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤—ã–µ WAL-—Å–µ–≥–º–µ–Ω—Ç—ã (–ø–æ 64 –ú–ë), —Å–ª–æ—Ç "–Ω–µ –º–æ–∂–µ—Ç" –∏—Ö –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å. | –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `heartbeat.interval.ms` –≤ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–µ. |
| **4. –ü—Ä–æ–±–ª–µ–º—ã –≤ SMT / Flink SQL** | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∑–∞–¥–∞–Ω–∏–π Flink –Ω–∞ –Ω–∞–ª–∏—á–∏–µ backpressure, –æ—à–∏–±–æ–∫ –∏–ª–∏ –ø–∞—É–∑. | –£–≤–µ–ª–∏—á–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É —á–µ–∫–ø–æ–∏–Ω—Ç–æ–≤, —É—Å—Ç—Ä–∞–Ω–∏—Ç—å backpressure. |

### ‚úÖ –ö—Ä–∞—Ç–∫–∏–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

1.  **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —á–µ–∫–ø–æ–∏–Ω—Ç—ã** (–≥–ª–∞–≤–Ω—ã–π —à–∞–≥). –í –≤–∞—à–µ–º –∑–∞–¥–∞–Ω–∏–∏ Flink SQL —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∏ –≤–∫–ª—é—á–µ–Ω—ã –∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ:
    ```sql
    -- –í –Ω–∞—á–∞–ª–µ SQL-—Å–∫—Ä–∏–ø—Ç–∞ –∑–∞–¥–∞–Ω–∏—è (–ø–µ—Ä–µ–¥ CREATE TABLE)
    SET 'execution.checkpointing.interval' = '30s';  -- –ù–∞–ø—Ä–∏–º–µ—Ä, 30 —Å–µ–∫—É–Ω–¥
    SET 'execution.checkpointing.tolerable-failed-checkpoints' = '10'; -- –†–∞–∑—Ä–µ—à–∏—Ç—å —Å–±–æ–∏
    ```
    –ó–∞—Ç–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ. **Flink —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –ø–æ–∑–∏—Ü–∏—é —Å–ª–æ—Ç–∞ (`confirmed_flush_lsn`) —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —á–µ–∫–ø–æ–∏–Ω—Ç–µ**.

2.  **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏** –≤ Postgres. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –º–µ—Ç—Ä–∏–∫–∞–º–∏ `confirmed_flush_lsn` –∫–∞–∂–¥—ã–µ 5-10 –º–∏–Ω—É—Ç. –ï—Å–ª–∏ —Å–ª–æ—Ç —Ä–∞—Å—Ç–µ—Ç, –Ω–æ `confirmed_flush_lsn` —Å—Ç–æ–∏—Ç –Ω–∞ –º–µ—Å—Ç–µ, —Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤ 1-3 –ø—É–Ω–∫—Ç–∞—Ö.

3.  **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ heartbeat –≤ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–µ**. –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Å–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –¥–æ–±–∞–≤–∏—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏:
    ```sql
    -- –í –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö —Ç–∞–±–ª–∏—Ü—ã-–∏—Å—Ç–æ—á–Ω–∏–∫–∞ Flink SQL –¥–æ–±–∞–≤—å—Ç–µ:
    'debezium.heartbeat.interval.ms' = '10000'
    ```
    –≠—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ WAL —Å–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –≤ –≤–∞—à–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, —á—Ç–æ–±—ã —Å–ª–æ—Ç –º–æ–≥ –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å—Å—è.

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ–∫–ø–æ–∏–Ω—Ç–æ–≤ –Ω–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ `confirmed_flush_lsn`. –ï—Å–ª–∏ –æ–Ω –Ω–∞—á–∞–ª –¥–≤–∏–≥–∞—Ç—å—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å `pg_current_wal_lsn()`, –∞ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ (`lag_behind_current`) —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª–æ—Å—å, –∑–Ω–∞—á–∏—Ç, –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞.
